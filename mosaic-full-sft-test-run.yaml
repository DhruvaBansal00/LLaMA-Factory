name: axolotl-vision-test-run
image: mosaicml/pytorch:2.3.1_cu121-python3.11-ubuntu20.04
compute:
  gpus: 32
  cluster: r15z1p1
  gpu_type: h100_80gb
integrations:
- integration_type: git_repo
  git_repo: DhruvaBansal00/LLaMA-Factory
  ssh_clone: true
  git_branch: main
- integration_type: pip_packages
  packages:
  - wandb
command: |-
  unset WORLD_SIZE
  pip3 install awscli
  cd LLaMA-Factory
  pip3 install ninja packaging
  pip3 install -e ".[torch,metrics,deepspeed,liger-kernel,bitsandbytes,flash-attn,auto-gptq]"
  wandb login

  FORCE_TORCHRUN=1 NNODES=4 NODE_RANK=0 MASTER_ADDR=$MASTER_ADDR MASTER_PORT=$MASTER_PORT llamafactory-cli train examples/train_full/llama3vision_full_sft.yaml
  FORCE_TORCHRUN=1 NNODES=4 NODE_RANK=1 MASTER_ADDR=$MASTER_ADDR MASTER_PORT=$MASTER_PORT llamafactory-cli train examples/train_full/llama3vision_full_sft.yaml
  FORCE_TORCHRUN=1 NNODES=4 NODE_RANK=2 MASTER_ADDR=$MASTER_ADDR MASTER_PORT=$MASTER_PORT llamafactory-cli train examples/train_full/llama3vision_full_sft.yaml
  FORCE_TORCHRUN=1 NNODES=4 NODE_RANK=3 MASTER_ADDR=$MASTER_ADDR MASTER_PORT=$MASTER_PORT llamafactory-cli train examples/train_full/llama3vision_full_sft.yaml